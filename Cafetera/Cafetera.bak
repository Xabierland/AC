;**********************************************	VARIABLES GLOBALES
ESTADO		EQU 	R7
EVENTO		EQU	R6
DISPLAY1	EQU 	0x30
DISPLAY2	EQU 	0x31
;**********************************************	VARIABLES ESPERA
M_05		EQU	P1.0
M_10		EQU	P1.1
M_20		EQU	P1.2

;**********************************************	VARIABLES VASO
P_HAY_VASO	EQU	P3.1
SN_PONER_VASO	EQU	P1.3
NO_ESTA_VASO	EQU	0X20.0
;**********************************************	VARIABLES AGUA
P_LLENO_AGUA	EQU	P3.0
P_LLENAR_AGUA	EQU 	P0.7
ESTA_VACIO	EQU	0X21.0


;**********************************************	VARIABLES PWM
PWM_FLAG	EQU	0
PWM0		EQU	128		;Si 0 son 0V y 255 son 5V -> 128 son 50%

;**********************************************	MAIN, LOOP & INIT
ORG 0x00
	AJMP MAIN

;INTERRUPCIONES

;PROGRAMA PRINCIPAL
ORG 0x7B
MAIN:
	ACALL INIT

LOOP:
	ACALL MAQ_EST
	AJMP LOOP

INIT:
	MOV ESTADO,#0X01
	MOV EVENTO,#0X00
	CLR SN_PONER_VASO
	SETB NO_ESTA_VASO
	CLR P_LLENAR_AGUA
	SETB ESTA_VACIO

	RET

;**********************************************	MAQUINA DE ESTADOS
MAQ_EST:
	MOV A, ESTADO
	RL A
	MOV DPTR, #TABLAESTADO
	JMP @A+DPTR
TABLAESTADO:
	AJMP ESPERA		;#0X00
	AJMP PONER_VASO		;#0X01
;	AJMP ECHAR_CAFE		;#0X02
;	AJMP MOLER_CAFE		;#0X03
	AJMP ECHAR_AGUA		;#0X04	



;**********************************************	ESTADO 0: ESPERA
ESPERA:
	ACALL E0_GENERADOR_EVENTOS
	MOV A, EVENTO
	RL A
	MOV DPTR, #TABLA_E0_EVENTOS
	JMP @A+DPTR

E0_GENERADOR_EVENTOS:
	JB M_05, E0_ENTRA_MONEDA

E0_ENTRA_MONEDA:


TABLA_E0_EVENTOS:
	AJMP E0_EVENTO_0
	AJMP E0_EVENTO_1
	AJMP E0_EVENTO_2
	AJMP E0_EVENTO_3

E0_EVENTO_0:
	RET

E0_EVENTO_1:

E0_EVENTO_2:

E0_EVENTO_3:
;**********************************************	ESTADO 1: PONER_VASO
PONER_VASO:
	ACALL E1_GENERADOR_EVENTOS
	MOV A, EVENTO
	RL A
	MOV DPTR, #TABLA_E1_EVENTOS
	JMP @A+DPTR

E1_GENERADOR_EVENTOS:
	JB P_HAY_VASO, E1_PASAR_SIG_ESTADO
	JB NO_ESTA_VASO, E1_PONER_VASO
	MOV EVENTO, #0X00
	RET

E1_PONER_VASO:
	MOV EVENTO, #0X02
	CLR NO_ESTA_VASO
	RET

E1_PASAR_SIG_ESTADO:
	MOV EVENTO, #0X01
	RET

TABLA_E1_EVENTOS:
	AJMP E1_EVENTO_0
	AJMP E1_EVENTO_1
	AJMP E1_EVENTO_2

E1_EVENTO_0:
	RET

E1_EVENTO_1:
	MOV ESTADO, #0X02
	CLR SN_PONER_VASO
	;ENCENDER MOLINILLO
	;PROGRAMAR TIMER
	RET

E1_EVENTO_2:
	SETB SN_PONER_VASO
	RET


;**********************************************	ESTADO 4: ECHAR AGUA
ECHAR_AGUA:
	ACALL E2_GENERADOR_EVENTOS
	MOV A, EVENTO
	RL A
	MOV DPTR, #TABLA_E2_EVENTOS
	JMP @A+DPTR

TABLA_E2_EVENTOS:
	AJMP E2_EVENTO_0
	AJMP E2_EVENTO_1
	AJMP E2_EVENTO_2

E2_GENERADOR_EVENTOS:
	JB P_LLENO_AGUA, E2_PASAR_SIG_ESTADO
	JB ESTA_VACIO, E2_ECHAR_AGUA
	MOV EVENTO, #0X00
	RET

E2_ECHAR_AGUA:
	MOV EVENTO, #0X02
	CLR ESTA_VACIO
	RET

E2_PASAR_SIG_ESTADO:
	MOV EVENTO, #0X01
	RET

E2_EVENTO_0:
	RET

E2_EVENTO_1:
	MOV ESTADO, #0X05
	CLR P_LLENAR_AGUA
	;PRECONDICIONES PROXIMO ESTADO
	RET

E2_EVENTO_2:
	SETB P_LLENAR_AGUA
	RET


;**********************************************	PWM
PWM_SETUP:
	MOV TMOD,#00H		;Timer 0 en modo 0
	MOV PWM0, #160
	SETB EA;		;Activar Interrupciones
	SETB ET0		;Activar las interrupciones del timer 0
	SETB TR0		;Empezar el timer

TIMER_0_INTERRUPT:
	JB PWM_FLAG, HIGH_DONE	;Si la flag esta en 1 saltamos a High_Done. Si no seguimos con Low_Done

LOW_DONE:
	SETB PWM_FLAG		;Pones la flag en 1		
	MOV TH0,PWM0		;Cargamos el valor mas alto del timer con el valor guardado en R7
	CLR TF0			;Limpiamos la flag del timer
	RETI	

HIGH_DONE:
	CLR PWM_FLAG		;Ponew la flag en 0	
	MOV A, #0FFH		;Movemos el valor 255 a A
	CLR C			;Limpiamos C que es el bit de llevada para que no afecte a la resta
	SUBB A, PWM0		;Restamos a A el valor de R7
	MOV TH0, A		;
	CLR TF0			;Limpiamos la flag del timer
	RETI

PWM_STOP:
	CLR TR0			
	RET

;**********************************************FIN
END

;PWM	https://www.8051projects.net/wiki/Pulse_Width_Modulation

