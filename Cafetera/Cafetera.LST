A51 MACRO ASSEMBLER  CAFETERA                                                             12/15/2021 20:44:26 PAGE     1


MACRO ASSEMBLER A51 V6.14
NO OBJECT MODULE REQUESTED
ASSEMBLER INVOKED BY: C:\Keil\C51\BIN\A51.EXE .\Cafetera.a SET(SMALL) DEBUG EP

LOC  OBJ            LINE     SOURCE

                       1     ;********************************************** VARIABLES GLOBALES
  REG                  2     ESTADO          EQU     R7
  REG                  3     EVENTO          EQU     R6
  0080                 4     DISPLAY1        EQU     P0
  00A0                 5     DISPLAY2        EQU     P2
                       6     ;********************************************** VARIABLES CAFE
  0023                 7     BEBIDA_SELEC    EQU     0X23
                       8     ;********************************************** VARIABLES ESPERA
  0090                 9     M_05            EQU     P1.0
  0091                10     M_10            EQU     P1.1
  0092                11     M_20            EQU     P1.2
  0022                12     MONEDERO        EQU     0X22
  0095                13     SEL_0           EQU     P1.5
  0096                14     SEL_1           EQU     P1.6
  0097                15     SEL_2           EQU     P1.7
  0024                16     PREC_LECHE      EQU     0x24
  0025                17     PREC_CORTADO    EQU     0x25
  0026                18     PREC_SOLO       EQU     0x26
                      19     ;********************************************** VARIABLES VASO
  00B1                20     P_HAY_VASO      EQU     P3.1
  0093                21     SN_PONER_VASO   EQU     P1.3
  0000                22     NO_ESTA_VASO    EQU     0X20.0
                      23     ;********************************************** VARIABLES AGUA
  00B0                24     P_LLENO_AGUA    EQU     P3.0
  0087                25     P_LLENAR_AGUA   EQU     P0.7
  0008                26     ESTA_VACIO      EQU     0X21.0
                      27     ;********************************************** VARIABLES TIMER
  0030                28     CONT0           EQU     0X30
  0031                29     CONT1           EQU     0X31
  0032                30     CONT2           EQU     0X32
                      31     ;********************************************** VARIABLES ADC
                      32     ADC0            EQU     P5.0
*** _________________________________________________^
*** ERROR #A17 IN 32 (.\Cafetera.a, LINE 32): INVALID BYTE BASE IN BIT ADDRESS EXPRESSION
                      33     ADC             EQU     P5.1    
*** _________________________________________________^
*** ERROR #A17 IN 33 (.\Cafetera.a, LINE 33): INVALID BYTE BASE IN BIT ADDRESS EXPRESSION
                      34     ;********************************************** VARIABLES PWM
                      35     
                      36     
                      37     ;********************************************** MAIN, LOOP & INIT
0000                  38     ORG 0x00
0000 017B             39             AJMP MAIN
                      40     
                      41     ;INTERRUPCIONES
000B                  42     ORG 0x0B
000B                  43             ACALL SUB_TMR
*** _______________________________________^
*** ERROR #A45 IN 43 (.\Cafetera.a, LINE 43): UNDEFINED SYMBOL (PASS-2)
000D 32               44             RETI
                      45     
0053                  46     ORG 0x53 
0053                  47             ACALL SUB_ADC
*** _______________________________________^
*** ERROR #A45 IN 47 (.\Cafetera.a, LINE 47): UNDEFINED SYMBOL (PASS-2)
0055 32               48             RETI
                      49     ;PROGRAMA PRINCIPAL
007B                  50     ORG 0x7B
A51 MACRO ASSEMBLER  CAFETERA                                                             12/15/2021 20:44:26 PAGE     2

007B                  51     MAIN:
007B 1181             52             ACALL INIT
                      53     
007D                  54     LOOP:
007D 11A0             55             ACALL MAQ_EST
007F 017D             56             AJMP LOOP
                      57     
0081                  58     INIT:
0081 7F00             59             MOV ESTADO,#0X00
0083 7E00             60             MOV EVENTO,#0X00
                      61             ;INIT ESTADO 0
0085 C290             62             CLR M_05
0087 C291             63             CLR M_10
0089 C292             64             CLR M_20
008B C222             65             CLR MONEDERO
008D C295             66             CLR SEL_0
008F C296             67             CLR SEL_1
0091 C297             68             CLR SEL_2
                      69             ;INIT ESTADO 1
0093 C2B1             70             CLR P_HAY_VASO          ;SOLO PARA PROBAR
0095 C293             71             CLR SN_PONER_VASO
0097 D200             72             SETB NO_ESTA_VASO
                      73             ;INIT ESTADO 4
0099 C2B0             74             CLR P_LLENO_AGUA        ;SOLO PARA PROBAR
009B C287             75             CLR P_LLENAR_AGUA
009D D208             76             SETB ESTA_VACIO
                      77             
009F 22               78             RET
                      79     
                      80     ;********************************************** MAQUINA DE ESTADOS
00A0                  81     MAQ_EST:
00A0 EF               82             MOV A, ESTADO
00A1 23               83             RL A
00A2 9000A6           84             MOV DPTR, #TABLA_ESTADOS
00A5 73               85             JMP @A+DPTR
00A6                  86     TABLA_ESTADOS:
00A6 01B0             87             AJMP ESPERA             ;#0X00
00A8 2135             88             AJMP PONER_VASO         ;#0X01
00AA 2167             89             AJMP PESAR_CAFE         ;#0X02
00AC 2182             90             AJMP MOLER_CAFE         ;#0X03
00AE 2182             91             AJMP ECHAR_AGUA         ;#0X04  
                      92     
                      93     
                      94     
                      95     ;********************************************** ESTADO 0: ESPERA
00B0                  96     ESPERA:
00B0 11B8             97             ACALL E0_GENERADOR_EVENTOS
00B2 EE               98             MOV A, EVENTO
00B3 23               99             RL A
00B4 900114          100             MOV DPTR, #TABLA_E0_EVENTOS
00B7 73              101             JMP @A+DPTR
                     102     
00B8                 103     E0_GENERADOR_EVENTOS:
                     104             ;Se introducen monedas?
00B8 20901C          105             JB M_05, E0_SUMA_05     ;Genera evento 1
00BB 209125          106             JB M_10, E0_SUMA_10     ;Genera evento 1
00BE 20922E          107             JB M_20, E0_SUMA_20     ;Genera evento 1
                     108     
                     109             ;Se ha seleccionado bebida?
00C1 E590            110             MOV A,P1
00C3 03              111             RR A
00C4 03              112             RR A
00C5 03              113             RR A
00C6 03              114             RR A
00C7 03              115             RR A
00C8 5407            116             ANL A,#00000111b
A51 MACRO ASSEMBLER  CAFETERA                                                             12/15/2021 20:44:26 PAGE     3

00CA F5F0            117             MOV B, A
00CC 602D            118             JZ NO_SELEC     ;Genera Evento 0
                     119             
                     120             ;Hay suficiente dinero?
00CE 11FE            121             ACALL SEL_PREC_BEBIDA
00D0 C3              122             CLR C
00D1 B52235          123             CJNE A, MONEDERO,COMPARACION    ;Genera evento 2 o 3
00D4 503B            124             JNC DINERO_SUFIC                ;Genera evento 3
00D6 22              125             RET
                     126     
00D7                 127     E0_SUMA_05:
00D7 C290            128             CLR M_05
00D9 E4              129             CLR A
00DA E522            130             MOV A,MONEDERO
00DC 2405            131             ADD A,#5
00DE F522            132             MOV MONEDERO, A
00E0 7E01            133             MOV EVENTO, #0X01
00E2 22              134             RET
                     135     
00E3                 136     E0_SUMA_10:
00E3 C291            137             CLR M_10
00E5 E4              138             CLR A
00E6 E522            139             MOV A, MONEDERO
00E8 240A            140             ADD A,#10
00EA F522            141             MOV MONEDERO, A
00EC 7E01            142             MOV EVENTO, #0X01
00EE 22              143             RET
                     144     
00EF                 145     E0_SUMA_20:
00EF C292            146             CLR M_20
00F1 E4              147             CLR A
00F2 E522            148             MOV A,MONEDERO
00F4 2414            149             ADD A,#20
00F6 F522            150             MOV MONEDERO, A
00F8 7E01            151             MOV EVENTO, #0X01
00FA 22              152             RET
                     153     
00FB                 154     NO_SELEC:
00FB 7E00            155             MOV EVENTO, #0X00
00FD 22              156             RET
                     157     
00FE                 158     SEL_PREC_BEBIDA:        ;Guarda en el acumulador el precio de la bebida
00FE 04              159             INC A
00FF 83              160             MOVC A, @A+PC
0100 22              161             RET
0101 00              162             DB 0H
0102 28              163             DB 28H
0103 23              164             DB 23H
0104 1E              165             DB 1EH
0105 00              166             DB 0H
0106 28              167             DB 28H
0107 23              168             DB 23H
0108 1E              169             DB 1EH
                     170     
0109                 171     COMPARACION:
0109 5003            172             JNC DINERO_NO_SUFIC     ;Genera evento 2
010B 2111            173             AJMP DINERO_SUFIC       ;Genera evento 3
010D 22              174             RET
                     175     
010E                 176     DINERO_NO_SUFIC:
010E 7E02            177             MOV EVENTO, #0X02
0110 22              178             RET
                     179     
0111                 180     DINERO_SUFIC:
0111 7E03            181             MOV EVENTO, #0X03
                     182             ;GUARDAR DATOS BEBIDA
A51 MACRO ASSEMBLER  CAFETERA                                                             12/15/2021 20:44:26 PAGE     4

0113 22              183             RET
                     184     
0114                 185     TABLA_E0_EVENTOS:
0114 211C            186             AJMP E0_EVENTO_0        ; Evento vacio
0116 211D            187             AJMP E0_EVENTO_1        ; Evento moneda introducida, actualizar display
0118 2120            188             AJMP E0_EVENTO_2        ; Bebida seleccionada pero dinero insuficiente
011A 2129            189             AJMP E0_EVENTO_3        ; Bebida seleccionada dinero suficiente
                     190     
011C                 191     E0_EVENTO_0:
011C 22              192             RET
                     193     
011D                 194     E0_EVENTO_1:
                     195             ;ACTUALIZAR EL DISPLAY CON VALOR DE MONEDERO
011D 7E00            196             MOV EVENTO,#0x00
011F 22              197             RET
                     198     
0120                 199     E0_EVENTO_2:
                     200             ;VALOR NO SUFICIENTE
                     201             ;DISPLAY
0120 C295            202             CLR SEL_0
0122 C296            203             CLR SEL_1
0124 C297            204             CLR SEL_2
0126 7E00            205             MOV EVENTO, #0x00
0128 22              206             RET
                     207     
0129                 208     E0_EVENTO_3:
0129 7F01            209             MOV ESTADO, #0x01
012B 7E00            210             MOV EVENTO, #0X00
012D 85F023          211             MOV BEBIDA_SELEC,B
0130 C293            212             CLR SN_PONER_VASO
0132 D200            213             SETB NO_ESTA_VASO
0134 22              214             RET
                     215     ;********************************************** ESTADO 1: PONER_VASO
0135                 216     PONER_VASO:
0135 313D            217             ACALL E1_GENERADOR_EVENTOS
0137 EE              218             MOV A, EVENTO
0138 23              219             RL A
0139 90014E          220             MOV DPTR, #TABLA_E1_EVENTOS
013C 73              221             JMP @A+DPTR
                     222     
013D                 223     E1_GENERADOR_EVENTOS:
013D 20B10B          224             JB P_HAY_VASO, E1_PASAR_SIG_ESTADO
0140 200003          225             JB NO_ESTA_VASO, E1_PONER_VASO
0143 7E00            226             MOV EVENTO, #0X00
0145 22              227             RET
                     228     
0146                 229     E1_PONER_VASO:
0146 7E02            230             MOV EVENTO, #0X02
0148 C200            231             CLR NO_ESTA_VASO
014A 22              232             RET
                     233     
014B                 234     E1_PASAR_SIG_ESTADO:
014B 7E01            235             MOV EVENTO, #0X01
014D 22              236             RET
                     237     
014E                 238     TABLA_E1_EVENTOS:
014E 2154            239             AJMP E1_EVENTO_0
0150 2155            240             AJMP E1_EVENTO_1
0152 2164            241             AJMP E1_EVENTO_2
                     242     
0154                 243     E1_EVENTO_0:
0154 22              244             RET
                     245     
0155                 246     E1_EVENTO_1:
0155 7F02            247             MOV ESTADO, #0X02
0157 C293            248             CLR SN_PONER_VASO
A51 MACRO ASSEMBLER  CAFETERA                                                             12/15/2021 20:44:26 PAGE     5

                     249             ;ENCENDER PESADO
0159 215C            250             AJMP ADC_SETUP
015B 22              251             RET
                     252     
015C                 253     ADC_SETUP:
015C D2AE            254             SETB 0xA8.6 ;Activa la interrupcion del ADC
015E 53C5F8          255             ANL 0xC5, #11111000b
0161 43C508          256             ORL 0xC5, #00001000b
                     257             
                     258             
0164                 259     E1_EVENTO_2:
0164 D293            260             SETB SN_PONER_VASO
0166 22              261             RET
                     262     
                     263     ;********************************************** ESTADO 2: PESAR CAFE
0167                 264     PESAR_CAFE:
0167 3173            265             ACALL E2_GENERADOR_EVENTOS
0169 EE              266             MOV A, EVENTO
016A 23              267             RL A
016B 90016F          268             MOV DPTR, #TABLA_E2_EVENTOS
016E 73              269             JMP @A+DPTR
                     270     
016F                 271     TABLA_E2_EVENTOS:
016F 2171            272             AJMP E2_EVENTO_0
                     273     
0171                 274     E2_EVENTO_0:
0171 22              275             RET
                     276     
0172                 277     E2_EVENTO_1:
0172 22              278             RET
                     279     
0173                 280     E2_GENERADOR_EVENTOS:
0173 E523            281             MOV A, BEBIDA_SELEC
0175 5404            282             ANL A, #00000100b
0177 6003            283             JZ CAFE
0179                 284             AJMP DESCAFE
*** ______________________________________^
*** ERROR #A45 IN 284 (.\Cafetera.a, LINE 284): UNDEFINED SYMBOL (PASS-2)
017B 22              285             RET
                     286     
017C                 287     CAFE:
                     288             
017C                 289     ACTIVAR_PWM:
017C                 290             MOV PWMP, #0X01
*** _____________________________________^
*** ERROR #A45 IN 290 (.\Cafetera.a, LINE 290): UNDEFINED SYMBOL (PASS-2)
017F                 291             MOV PWM0, B3H
*** _____________________________________^
*** ___________________________________________^
*** ERROR #A45 IN 291 (.\Cafetera.a, LINE 291): UNDEFINED SYMBOL (PASS-2)
*** ERROR #A45 IN 291 (.\Cafetera.a, LINE 291): UNDEFINED SYMBOL (PASS-2)
                     292     
                     293     ;********************************************** ESTADO 3: MOLER CAFE
0182                 294     MOLER_CAFE:
                     295     ;********************************************** ESTADO 4: ECHAR AGUA
0182                 296     ECHAR_AGUA:
0182 3190            297             ACALL E4_GENERADOR_EVENTOS
0184 EE              298             MOV A, EVENTO
0185 23              299             RL A
0186 90018A          300             MOV DPTR, #TABLA_E4_EVENTOS
0189 73              301             JMP @A+DPTR
                     302     
018A                 303     TABLA_E4_EVENTOS:
018A 21A1            304             AJMP E4_EVENTO_0
018C 21A2            305             AJMP E4_EVENTO_1
018E 21A7            306             AJMP E4_EVENTO_2
A51 MACRO ASSEMBLER  CAFETERA                                                             12/15/2021 20:44:26 PAGE     6

                     307     
0190                 308     E4_GENERADOR_EVENTOS:
0190 20B00B          309             JB P_LLENO_AGUA, E4_PASAR_SIG_ESTADO
0193 200803          310             JB ESTA_VACIO, E4_ECHAR_AGUA
0196 7E00            311             MOV EVENTO, #0X00
0198 22              312             RET
                     313     
0199                 314     E4_ECHAR_AGUA:
0199 7E02            315             MOV EVENTO, #0X02
019B C208            316             CLR ESTA_VACIO
019D 22              317             RET
                     318     
019E                 319     E4_PASAR_SIG_ESTADO:
019E 7E05            320             MOV EVENTO, #0X05
01A0 22              321             RET
                     322     
01A1                 323     E4_EVENTO_0:
01A1 22              324             RET
                     325     
01A2                 326     E4_EVENTO_1:
01A2 7F05            327             MOV ESTADO, #0X05
01A4 C287            328             CLR P_LLENAR_AGUA
                     329             ;PRECONDICIONES PROXIMO ESTADO
01A6 22              330             RET
                     331     
01A7                 332     E4_EVENTO_2:
01A7 D287            333             SETB P_LLENAR_AGUA
01A9 22              334             RET
                     335     ;********************************************** ESTADO 5: CALENTAR AGUA
                     336     ;********************************************** ESTADO 6: SERVIR CAFE
                     337     ;********************************************** ESTADO 7: ECHAR LECHE
                     338     ;********************************************** ESTADO 8: FIN
                     339     
01AA                 340     ACTIVAR_TIMER:
01AA                 341             ORL TMOD #00000001b
*** __________________________________________^
*** ERROR #A9 IN 341 (.\Cafetera.a, LINE 341): SYNTAX ERROR
                     342             ;?
01AD 758CF8          343             MOV TH0, #0XF8
01B0 758A30          344             MOV TL0, #0X30
01B3 D2A9            345             SETB 0Xa8.1
01B5                 346             SETB TCOM.4
*** ______________________________________^
*** ERROR #A17 IN 346 (.\Cafetera.a, LINE 346): INVALID BYTE BASE IN BIT ADDRESS EXPRESSION
01B5 753000          347             MOV CONT0, #0
01B8 753100          348             MOV CONT1, #0
01BB 753200          349             MOV CONT2, #0
                     350             
                     351     ;**********************************************FIN
                     352     END
                             
                             
                             
A51 MACRO ASSEMBLER  CAFETERA                                                             12/15/2021 20:44:26 PAGE     7

SYMBOL TABLE LISTING
------ ----- -------


N A M E               T Y P E  V A L U E   ATTRIBUTES

ACTIVAR_PWM. . . . .  C ADDR   017CH   A   
ACTIVAR_TIMER. . . .  C ADDR   01AAH   A   
ADC. . . . . . . . .  B ADDR   0020H.1 A   
ADC0 . . . . . . . .  B ADDR   0020H.0 A   
ADC_SETUP. . . . . .  C ADDR   015CH   A   
B. . . . . . . . . .  D ADDR   00F0H   A   
B3H. . . . . . . . .    ----   -----       
BEBIDA_SELEC . . . .  N NUMB   0023H   A   
CAFE . . . . . . . .  C ADDR   017CH   A   
COMPARACION. . . . .  C ADDR   0109H   A   
CONT0. . . . . . . .  N NUMB   0030H   A   
CONT1. . . . . . . .  N NUMB   0031H   A   
CONT2. . . . . . . .  N NUMB   0032H   A   
DESCAFE. . . . . . .    ----   -----       
DINERO_NO_SUFIC. . .  C ADDR   010EH   A   
DINERO_SUFIC . . . .  C ADDR   0111H   A   
DISPLAY1 . . . . . .  D ADDR   0080H   A   
DISPLAY2 . . . . . .  D ADDR   00A0H   A   
E0_EVENTO_0. . . . .  C ADDR   011CH   A   
E0_EVENTO_1. . . . .  C ADDR   011DH   A   
E0_EVENTO_2. . . . .  C ADDR   0120H   A   
E0_EVENTO_3. . . . .  C ADDR   0129H   A   
E0_GENERADOR_EVENTOS  C ADDR   00B8H   A   
E0_SUMA_05 . . . . .  C ADDR   00D7H   A   
E0_SUMA_10 . . . . .  C ADDR   00E3H   A   
E0_SUMA_20 . . . . .  C ADDR   00EFH   A   
E1_EVENTO_0. . . . .  C ADDR   0154H   A   
E1_EVENTO_1. . . . .  C ADDR   0155H   A   
E1_EVENTO_2. . . . .  C ADDR   0164H   A   
E1_GENERADOR_EVENTOS  C ADDR   013DH   A   
E1_PASAR_SIG_ESTADO.  C ADDR   014BH   A   
E1_PONER_VASO. . . .  C ADDR   0146H   A   
E2_EVENTO_0. . . . .  C ADDR   0171H   A   
E2_EVENTO_1. . . . .  C ADDR   0172H   A   
E2_GENERADOR_EVENTOS  C ADDR   0173H   A   
E4_ECHAR_AGUA. . . .  C ADDR   0199H   A   
E4_EVENTO_0. . . . .  C ADDR   01A1H   A   
E4_EVENTO_1. . . . .  C ADDR   01A2H   A   
E4_EVENTO_2. . . . .  C ADDR   01A7H   A   
E4_GENERADOR_EVENTOS  C ADDR   0190H   A   
E4_PASAR_SIG_ESTADO.  C ADDR   019EH   A   
ECHAR_AGUA . . . . .  C ADDR   0182H   A   
ESPERA . . . . . . .  C ADDR   00B0H   A   
ESTADO . . . . . . .    REG    R7          
ESTA_VACIO . . . . .  B ADDR   0021H.0 A   
EVENTO . . . . . . .    REG    R6          
INIT . . . . . . . .  C ADDR   0081H   A   
LOOP . . . . . . . .  C ADDR   007DH   A   
MAIN . . . . . . . .  C ADDR   007BH   A   
MAQ_EST. . . . . . .  C ADDR   00A0H   A   
MOLER_CAFE . . . . .  C ADDR   0182H   A   
MONEDERO . . . . . .  N NUMB   0022H   A   
M_05 . . . . . . . .  B ADDR   0090H.0 A   
M_10 . . . . . . . .  B ADDR   0090H.1 A   
M_20 . . . . . . . .  B ADDR   0090H.2 A   
NO_ESTA_VASO . . . .  B ADDR   0020H.0 A   
NO_SELEC . . . . . .  C ADDR   00FBH   A   
P0 . . . . . . . . .  D ADDR   0080H   A   
P1 . . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . . .  D ADDR   00A0H   A   
A51 MACRO ASSEMBLER  CAFETERA                                                             12/15/2021 20:44:26 PAGE     8

P3 . . . . . . . . .  D ADDR   00B0H   A   
P5 . . . . . . . . .    ----   -----       
PESAR_CAFE . . . . .  C ADDR   0167H   A   
PONER_VASO . . . . .  C ADDR   0135H   A   
PREC_CORTADO . . . .  N NUMB   0025H   A   
PREC_LECHE . . . . .  N NUMB   0024H   A   
PREC_SOLO. . . . . .  N NUMB   0026H   A   
PWM0 . . . . . . . .    ----   -----       
PWMP . . . . . . . .    ----   -----       
P_HAY_VASO . . . . .  B ADDR   00B0H.1 A   
P_LLENAR_AGUA. . . .  B ADDR   0080H.7 A   
P_LLENO_AGUA . . . .  B ADDR   00B0H.0 A   
SEL_0. . . . . . . .  B ADDR   0090H.5 A   
SEL_1. . . . . . . .  B ADDR   0090H.6 A   
SEL_2. . . . . . . .  B ADDR   0090H.7 A   
SEL_PREC_BEBIDA. . .  C ADDR   00FEH   A   
SN_PONER_VASO. . . .  B ADDR   0090H.3 A   
SUB_ADC. . . . . . .    ----   -----       
SUB_TMR. . . . . . .    ----   -----       
TABLA_E0_EVENTOS . .  C ADDR   0114H   A   
TABLA_E1_EVENTOS . .  C ADDR   014EH   A   
TABLA_E2_EVENTOS . .  C ADDR   016FH   A   
TABLA_E4_EVENTOS . .  C ADDR   018AH   A   
TABLA_ESTADOS. . . .  C ADDR   00A6H   A   
TCOM . . . . . . . .    ----   -----       
TH0. . . . . . . . .  D ADDR   008CH   A   
TL0. . . . . . . . .  D ADDR   008AH   A   
TMOD . . . . . . . .  D ADDR   0089H   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 10 ERROR(S)
