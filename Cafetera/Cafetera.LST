A51 MACRO ASSEMBLER  CAFETERA                                                             11/24/2021 21:38:58 PAGE     1


MACRO ASSEMBLER A51 V6.14
OBJECT MODULE PLACED IN .\Cafetera.OBJ
ASSEMBLER INVOKED BY: C:\Keil\C51\BIN\A51.EXE .\Cafetera.a SET(SMALL) DEBUG EP

LOC  OBJ            LINE     SOURCE

                       1     ;********************************************** VARIABLES GLOBALES
  REG                  2     ESTADO          EQU     R7
  REG                  3     EVENTO          EQU     R6
  0030                 4     DISPLAY1        EQU     0x30
  0031                 5     DISPLAY2        EQU     0x31
                       6     ;********************************************** VARIABLES ESPERA
  0090                 7     M_05            EQU     P1.0
  0091                 8     M_10            EQU     P1.1
  0092                 9     M_20            EQU     P1.2
                      10     
                      11     ;********************************************** VARIABLES VASO
  00B1                12     P_HAY_VASO      EQU     P3.1
  0093                13     SN_PONER_VASO   EQU     P1.3
  0000                14     NO_ESTA_VASO    EQU     0X20.0
                      15     ;********************************************** VARIABLES AGUA
  00B0                16     P_LLENO_AGUA    EQU     P3.0
  0087                17     P_LLENAR_AGUA   EQU     P0.7
  0008                18     ESTA_VACIO      EQU     0X21.0
                      19     
                      20     
                      21     ;********************************************** VARIABLES PWM
  0000                22     PWM_FLAG        EQU     0
  0080                23     PWM0            EQU     128             ;Si 0 son 0V y 255 son 5V -> 128 son 50%
                      24     
                      25     ;********************************************** MAIN, LOOP & INIT
0000                  26     ORG 0x00
0000 017B             27             AJMP MAIN
                      28     
                      29     ;INTERRUPCIONES
                      30     
                      31     ;PROGRAMA PRINCIPAL
007B                  32     ORG 0x7B
007B                  33     MAIN:
007B 1181             34             ACALL INIT
                      35     
007D                  36     LOOP:
007D 118E             37             ACALL MAQ_EST
007F 017D             38             AJMP LOOP
                      39     
0081                  40     INIT:
0081 7F01             41             MOV ESTADO,#0X01
0083 7E00             42             MOV EVENTO,#0X00
0085 C293             43             CLR SN_PONER_VASO
0087 D200             44             SETB NO_ESTA_VASO
0089 C287             45             CLR P_LLENAR_AGUA
008B D208             46             SETB ESTA_VACIO
                      47     
008D 22               48             RET
                      49     
                      50     ;********************************************** MAQUINA DE ESTADOS
008E                  51     MAQ_EST:
008E EF               52             MOV A, ESTADO
008F 23               53             RL A
0090 900094           54             MOV DPTR, #TABLAESTADO
0093 73               55             JMP @A+DPTR
0094                  56     TABLAESTADO:
0094 019A             57             AJMP ESPERA             ;#0X00
0096 01AE             58             AJMP PONER_VASO         ;#0X01
A51 MACRO ASSEMBLER  CAFETERA                                                             11/24/2021 21:38:58 PAGE     2

                      59     ;       AJMP ECHAR_CAFE         ;#0X02
                      60     ;       AJMP MOLER_CAFE         ;#0X03
0098 01D6             61             AJMP ECHAR_AGUA         ;#0X04  
                      62     
                      63     
                      64     
                      65     ;********************************************** ESTADO 0: ESPERA
009A                  66     ESPERA:
009A 11A2             67             ACALL E0_GENERADOR_EVENTOS
009C EE               68             MOV A, EVENTO
009D 23               69             RL A
009E 9000A5           70             MOV DPTR, #TABLA_E0_EVENTOS
00A1 73               71             JMP @A+DPTR
                      72     
00A2                  73     E0_GENERADOR_EVENTOS:
00A2 209000           74             JB M_05, E0_ENTRA_MONEDA
                      75     
00A5                  76     E0_ENTRA_MONEDA:
                      77     
                      78     
00A5                  79     TABLA_E0_EVENTOS:
00A5 01AD             80             AJMP E0_EVENTO_0
00A7 01AE             81             AJMP E0_EVENTO_1
00A9 01AE             82             AJMP E0_EVENTO_2
00AB 01AE             83             AJMP E0_EVENTO_3
                      84     
00AD                  85     E0_EVENTO_0:
00AD 22               86             RET
                      87     
00AE                  88     E0_EVENTO_1:
                      89     
00AE                  90     E0_EVENTO_2:
                      91     
00AE                  92     E0_EVENTO_3:
                      93     ;********************************************** ESTADO 1: PONER_VASO
00AE                  94     PONER_VASO:
00AE 11B6             95             ACALL E1_GENERADOR_EVENTOS
00B0 EE               96             MOV A, EVENTO
00B1 23               97             RL A
00B2 9000C7           98             MOV DPTR, #TABLA_E1_EVENTOS
00B5 73               99             JMP @A+DPTR
                     100     
00B6                 101     E1_GENERADOR_EVENTOS:
00B6 20B10B          102             JB P_HAY_VASO, E1_PASAR_SIG_ESTADO
00B9 200003          103             JB NO_ESTA_VASO, E1_PONER_VASO
00BC 7E00            104             MOV EVENTO, #0X00
00BE 22              105             RET
                     106     
00BF                 107     E1_PONER_VASO:
00BF 7E02            108             MOV EVENTO, #0X02
00C1 C200            109             CLR NO_ESTA_VASO
00C3 22              110             RET
                     111     
00C4                 112     E1_PASAR_SIG_ESTADO:
00C4 7E01            113             MOV EVENTO, #0X01
00C6 22              114             RET
                     115     
00C7                 116     TABLA_E1_EVENTOS:
00C7 01CD            117             AJMP E1_EVENTO_0
00C9 01CE            118             AJMP E1_EVENTO_1
00CB 01D3            119             AJMP E1_EVENTO_2
                     120     
00CD                 121     E1_EVENTO_0:
00CD 22              122             RET
                     123     
00CE                 124     E1_EVENTO_1:
A51 MACRO ASSEMBLER  CAFETERA                                                             11/24/2021 21:38:58 PAGE     3

00CE 7F02            125             MOV ESTADO, #0X02
00D0 C293            126             CLR SN_PONER_VASO
                     127             ;ENCENDER MOLINILLO
                     128             ;PROGRAMAR TIMER
00D2 22              129             RET
                     130     
00D3                 131     E1_EVENTO_2:
00D3 D293            132             SETB SN_PONER_VASO
00D5 22              133             RET
                     134     
                     135     
                     136     ;********************************************** ESTADO 4: ECHAR AGUA
00D6                 137     ECHAR_AGUA:
00D6 11E4            138             ACALL E2_GENERADOR_EVENTOS
00D8 EE              139             MOV A, EVENTO
00D9 23              140             RL A
00DA 9000DE          141             MOV DPTR, #TABLA_E2_EVENTOS
00DD 73              142             JMP @A+DPTR
                     143     
00DE                 144     TABLA_E2_EVENTOS:
00DE 01F5            145             AJMP E2_EVENTO_0
00E0 01F6            146             AJMP E2_EVENTO_1
00E2 01FB            147             AJMP E2_EVENTO_2
                     148     
00E4                 149     E2_GENERADOR_EVENTOS:
00E4 20B00B          150             JB P_LLENO_AGUA, E2_PASAR_SIG_ESTADO
00E7 200803          151             JB ESTA_VACIO, E2_ECHAR_AGUA
00EA 7E00            152             MOV EVENTO, #0X00
00EC 22              153             RET
                     154     
00ED                 155     E2_ECHAR_AGUA:
00ED 7E02            156             MOV EVENTO, #0X02
00EF C208            157             CLR ESTA_VACIO
00F1 22              158             RET
                     159     
00F2                 160     E2_PASAR_SIG_ESTADO:
00F2 7E01            161             MOV EVENTO, #0X01
00F4 22              162             RET
                     163     
00F5                 164     E2_EVENTO_0:
00F5 22              165             RET
                     166     
00F6                 167     E2_EVENTO_1:
00F6 7F05            168             MOV ESTADO, #0X05
00F8 C287            169             CLR P_LLENAR_AGUA
                     170             ;PRECONDICIONES PROXIMO ESTADO
00FA 22              171             RET
                     172     
00FB                 173     E2_EVENTO_2:
00FB D287            174             SETB P_LLENAR_AGUA
00FD 22              175             RET
                     176     
                     177     
                     178     ;********************************************** PWM
00FE                 179     PWM_SETUP:
00FE 758900          180             MOV TMOD,#00H           ;Timer 0 en modo 0
0101 7580A0          181             MOV PWM0, #160
0104 D2AF            182             SETB EA;                ;Activar Interrupciones
0106 D2A9            183             SETB ET0                ;Activar las interrupciones del timer 0
0108 D28C            184             SETB TR0                ;Empezar el timer
                     185     
010A                 186     TIMER_0_INTERRUPT:
010A 200008          187             JB PWM_FLAG, HIGH_DONE  ;Si la flag esta en 1 saltamos a High_Done. Si no seguimos 
                             con Low_Done
                     188     
010D                 189     LOW_DONE:
A51 MACRO ASSEMBLER  CAFETERA                                                             11/24/2021 21:38:58 PAGE     4

010D D200            190             SETB PWM_FLAG           ;Pones la flag en 1             
010F 85808C          191             MOV TH0,PWM0            ;Cargamos el valor mas alto del timer con el valor guardado
                              en R7
0112 C28D            192             CLR TF0                 ;Limpiamos la flag del timer
0114 32              193             RETI    
                     194     
0115                 195     HIGH_DONE:
0115 C200            196             CLR PWM_FLAG            ;Ponew la flag en 0     
0117 74FF            197             MOV A, #0FFH            ;Movemos el valor 255 a A
0119 C3              198             CLR C                   ;Limpiamos C que es el bit de llevada para que no afecte a 
                             la resta
011A 9580            199             SUBB A, PWM0            ;Restamos a A el valor de R7
011C F58C            200             MOV TH0, A              ;
011E C28D            201             CLR TF0                 ;Limpiamos la flag del timer
0120 32              202             RETI
                     203     
0121                 204     PWM_STOP:
0121 C28C            205             CLR TR0                 
0123 22              206             RET
                     207     
                     208     ;**********************************************FIN
                     209     END
                             
                             ;PWM    https://www.8051projects.net/wiki/Pulse_Width_Modulation
                             
A51 MACRO ASSEMBLER  CAFETERA                                                             11/24/2021 21:38:58 PAGE     5

SYMBOL TABLE LISTING
------ ----- -------


N A M E               T Y P E  V A L U E   ATTRIBUTES

DISPLAY1 . . . . . .  N NUMB   0030H   A   
DISPLAY2 . . . . . .  N NUMB   0031H   A   
E0_ENTRA_MONEDA. . .  C ADDR   00A5H   A   
E0_EVENTO_0. . . . .  C ADDR   00ADH   A   
E0_EVENTO_1. . . . .  C ADDR   00AEH   A   
E0_EVENTO_2. . . . .  C ADDR   00AEH   A   
E0_EVENTO_3. . . . .  C ADDR   00AEH   A   
E0_GENERADOR_EVENTOS  C ADDR   00A2H   A   
E1_EVENTO_0. . . . .  C ADDR   00CDH   A   
E1_EVENTO_1. . . . .  C ADDR   00CEH   A   
E1_EVENTO_2. . . . .  C ADDR   00D3H   A   
E1_GENERADOR_EVENTOS  C ADDR   00B6H   A   
E1_PASAR_SIG_ESTADO.  C ADDR   00C4H   A   
E1_PONER_VASO. . . .  C ADDR   00BFH   A   
E2_ECHAR_AGUA. . . .  C ADDR   00EDH   A   
E2_EVENTO_0. . . . .  C ADDR   00F5H   A   
E2_EVENTO_1. . . . .  C ADDR   00F6H   A   
E2_EVENTO_2. . . . .  C ADDR   00FBH   A   
E2_GENERADOR_EVENTOS  C ADDR   00E4H   A   
E2_PASAR_SIG_ESTADO.  C ADDR   00F2H   A   
EA . . . . . . . . .  B ADDR   00A8H.7 A   
ECHAR_AGUA . . . . .  C ADDR   00D6H   A   
ESPERA . . . . . . .  C ADDR   009AH   A   
ESTADO . . . . . . .    REG    R7          
ESTA_VACIO . . . . .  B ADDR   0021H.0 A   
ET0. . . . . . . . .  B ADDR   00A8H.1 A   
EVENTO . . . . . . .    REG    R6          
HIGH_DONE. . . . . .  C ADDR   0115H   A   
INIT . . . . . . . .  C ADDR   0081H   A   
LOOP . . . . . . . .  C ADDR   007DH   A   
LOW_DONE . . . . . .  C ADDR   010DH   A   
MAIN . . . . . . . .  C ADDR   007BH   A   
MAQ_EST. . . . . . .  C ADDR   008EH   A   
M_05 . . . . . . . .  B ADDR   0090H.0 A   
M_10 . . . . . . . .  B ADDR   0090H.1 A   
M_20 . . . . . . . .  B ADDR   0090H.2 A   
NO_ESTA_VASO . . . .  B ADDR   0020H.0 A   
P0 . . . . . . . . .  D ADDR   0080H   A   
P1 . . . . . . . . .  D ADDR   0090H   A   
P3 . . . . . . . . .  D ADDR   00B0H   A   
PONER_VASO . . . . .  C ADDR   00AEH   A   
PWM0 . . . . . . . .  N NUMB   0080H   A   
PWM_FLAG . . . . . .  N NUMB   0000H   A   
PWM_SETUP. . . . . .  C ADDR   00FEH   A   
PWM_STOP . . . . . .  C ADDR   0121H   A   
P_HAY_VASO . . . . .  B ADDR   00B0H.1 A   
P_LLENAR_AGUA. . . .  B ADDR   0080H.7 A   
P_LLENO_AGUA . . . .  B ADDR   00B0H.0 A   
SN_PONER_VASO. . . .  B ADDR   0090H.3 A   
TABLAESTADO. . . . .  C ADDR   0094H   A   
TABLA_E0_EVENTOS . .  C ADDR   00A5H   A   
TABLA_E1_EVENTOS . .  C ADDR   00C7H   A   
TABLA_E2_EVENTOS . .  C ADDR   00DEH   A   
TF0. . . . . . . . .  B ADDR   0088H.5 A   
TH0. . . . . . . . .  D ADDR   008CH   A   
TIMER_0_INTERRUPT. .  C ADDR   010AH   A   
TMOD . . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . . .  B ADDR   0088H.4 A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
