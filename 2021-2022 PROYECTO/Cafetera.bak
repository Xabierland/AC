;**********************************************	VARIABLES GLOBALES
ESTADO		EQU 	R7
EVENTO		EQU	R6
DISPLAY1	EQU 	P0
DISPLAY2	EQU 	P2
;**********************************************	VARIABLES CAFE
BEBIDA_SELEC	EQU	0X23
;**********************************************	VARIABLES ESPERA
M_05		EQU	P1.0
M_10		EQU	P1.1
M_20		EQU	P1.2
MONEDERO	EQU	0X22
SEL_0		EQU	P1.5
SEL_1		EQU	P1.6
SEL_2		EQU	P1.7
PREC_LECHE	EQU	0x24
PREC_CORTADO	EQU	0x25
PREC_SOLO	EQU	0x26
;**********************************************	VARIABLES VASO
P_HAY_VASO	EQU	P3.1
SN_PONER_VASO	EQU	P1.3
NO_ESTA_VASO	EQU	0X20.0
;**********************************************	VARIABLES PESO
NO_SELEC_GRANO	EQU	0X27.0
;**********************************************	VARIABLES MOLER

;**********************************************	VARIABLES AGUA
P_LLENO_AGUA	EQU	P3.0
P_LLENAR_AGUA	EQU 	P0.7
ESTA_VACIO	EQU	0X21.0
;**********************************************	VARIABLES CALENTAR
;**********************************************	VARIABLES SERVIR
;**********************************************	VARIABLES LECHE
;**********************************************	VARIABLES FIN
;**********************************************	VARIABLES TIMER
CONT0		EQU	0X30
CONT1		EQU	0X31
CONT2		EQU	0X32
TIMER_FLAG	EQU	0X33.0
;**********************************************	VARIABLES ADC
ADC0		EQU	P5.0
ADC		EQU	P5.1
ADCH		EQU	0xC6	
;**********************************************	VARIABLES PWM


;**********************************************	MAIN, LOOP & INIT
ORG 0x00
	AJMP MAIN

;INTERRUPCIONES
ORG 0x0B
	ACALL SUB_TMR
	RETI

ORG 0x53 
	ACALL SUB_ADC
	RETI
;PROGRAMA PRINCIPAL
ORG 0x7B
MAIN:
	ACALL INIT

LOOP:
	ACALL MAQ_EST
	AJMP LOOP

INIT:
	MOV ESTADO,#0X00
	MOV EVENTO,#0X00
	;INIT ESTADO 0
	CLR M_05
	CLR M_10
	CLR M_20
	CLR MONEDERO
	CLR SEL_0
	CLR SEL_1
	CLR SEL_2
	;INIT ESTADO 1
	CLR P_HAY_VASO		;SOLO PARA PROBAR
	CLR SN_PONER_VASO
	SETB NO_ESTA_VASO	;SOLO PARA LA PRIMERA VUELTA
	;INIT ESTADO 2
	SETB NO_SELEC_GRANO		;SOLO PARA LA PRIMERA VUELTA
	;INIT ESTADO 4
	CLR P_LLENO_AGUA	;SOLO PARA PROBAR
	CLR P_LLENAR_AGUA
	SETB ESTA_VACIO		;SOLO PARA LA PRIMERA VUELTA
	
	RET

;**********************************************	MAQUINA DE ESTADOS
MAQ_EST:
	MOV A, ESTADO
	RL A
	MOV DPTR, #TABLA_ESTADOS
	JMP @A+DPTR
TABLA_ESTADOS:
	AJMP ESPERA		;#0X00
	AJMP PONER_VASO		;#0X01
	AJMP PESAR_CAFE		;#0X02
	AJMP MOLER_CAFE		;#0X03
	AJMP ECHAR_AGUA		;#0X04
	AJMP CALENTAR_AGUA	;#0X05
	AJMP SERVIR_CAFE	;#0X06
	AJMP ECHAR_LECHE	;#0X07
	AJMP FIN		;#0X08	


;**********************************************	ESTADO 0: ESPERA
ESPERA:
	ACALL E0_GENERADOR_EVENTOS
	MOV A, EVENTO
	RL A
	MOV DPTR, #TABLA_E0_EVENTOS
	JMP @A+DPTR

E0_GENERADOR_EVENTOS:
	;Se introducen monedas?
	JB M_05, E0_SUMA_05	;Genera evento 1
	JB M_10, E0_SUMA_10	;Genera evento 1
	JB M_20, E0_SUMA_20	;Genera evento 1

	;Se ha seleccionado bebida?
	MOV A,P1
	RR A
	RR A
	RR A
	RR A
	RR A
	ANL A,#00000111b
	MOV B, A
	JZ NO_SELEC	;Genera Evento 0
	
	;Hay suficiente dinero?
	ACALL SEL_PREC_BEBIDA
	CLR C
	CJNE A, MONEDERO,COMPARACION	;Genera evento 2 o 3
	JNC DINERO_SUFIC		;Genera evento 3
	RET

E0_SUMA_05:
	CLR M_05
	CLR A
	MOV A,MONEDERO
	ADD A,#5
	MOV MONEDERO, A
	MOV EVENTO, #0X01
	RET

E0_SUMA_10:
	CLR M_10
	CLR A
	MOV A, MONEDERO
	ADD A,#10
	MOV MONEDERO, A
	MOV EVENTO, #0X01
	RET

E0_SUMA_20:
	CLR M_20
	CLR A
	MOV A,MONEDERO
	ADD A,#20
	MOV MONEDERO, A
	MOV EVENTO, #0X01
	RET

NO_SELEC:
	MOV EVENTO, #0X00
	RET

SEL_PREC_BEBIDA:	;Guarda en el acumulador el precio de la bebida
	INC A
	MOVC A, @A+PC
	RET
	DB 0H
	DB 28H
	DB 23H
	DB 1EH
	DB 0H
	DB 28H
	DB 23H
	DB 1EH

COMPARACION:
	JNC DINERO_NO_SUFIC	;Genera evento 2
	AJMP DINERO_SUFIC	;Genera evento 3
	RET

DINERO_NO_SUFIC:
	MOV EVENTO, #0X02
	RET

DINERO_SUFIC:
	MOV EVENTO, #0X03
	;GUARDAR DATOS BEBIDA
	RET

TABLA_E0_EVENTOS:
	AJMP E0_EVENTO_0	; Evento vacio
	AJMP E0_EVENTO_1	; Evento moneda introducida, actualizar display
	AJMP E0_EVENTO_2	; Bebida seleccionada pero dinero insuficiente
	AJMP E0_EVENTO_3	; Bebida seleccionada dinero suficiente

E0_EVENTO_0:
	RET

E0_EVENTO_1:
	;ACTUALIZAR EL DISPLAY CON VALOR DE MONEDERO
	MOV EVENTO,#0x00
	RET

E0_EVENTO_2:
	;VALOR NO SUFICIENTE
	;DISPLAY
	CLR SEL_0
	CLR SEL_1
	CLR SEL_2
	MOV EVENTO, #0x00
	RET

E0_EVENTO_3:
	MOV ESTADO, #0x01
	MOV EVENTO, #0X00
	MOV BEBIDA_SELEC,B
	CLR SN_PONER_VASO
	SETB NO_ESTA_VASO
	RET
;**********************************************	ESTADO 1: PONER_VASO
PONER_VASO:
	ACALL E1_GENERADOR_EVENTOS
	MOV A, EVENTO
	RL A
	MOV DPTR, #TABLA_E1_EVENTOS
	JMP @A+DPTR

E1_GENERADOR_EVENTOS:
	JB P_HAY_VASO, E1_PASAR_SIG_ESTADO
	JB NO_ESTA_VASO, E1_PONER_VASO
	MOV EVENTO, #0X00
	RET

E1_PONER_VASO:
	MOV EVENTO, #0X02
	CLR NO_ESTA_VASO
	RET

E1_PASAR_SIG_ESTADO:
	MOV EVENTO, #0X01
	RET

TABLA_E1_EVENTOS:
	AJMP E1_EVENTO_0
	AJMP E1_EVENTO_1
	AJMP E1_EVENTO_2

E1_EVENTO_0:
	RET

E1_EVENTO_1:
	MOV ESTADO, #0X02
	CLR SN_PONER_VASO
	;ENCENDER PESADO
	AJMP ADC_SETUP
	RET

	
E1_EVENTO_2:
	SETB SN_PONER_VASO
	RET

;**********************************************	ESTADO 2: PESAR CAFE
PESAR_CAFE:
	ACALL E2_GENERADOR_EVENTOS
	MOV A, EVENTO
	RL A
	MOV DPTR, #TABLA_E2_EVENTOS
	JMP @A+DPTR

E2_GENERADOR_EVENTOS:
	JNB NO_SELEC_GRANO, SELEC_GRANO

SELEC_GRANO:
	CLR NO_SELEC_GRANO
	MOV A, BEBIDA_SELEC
	ANL A, #00000100b
	JZ CAFE
	AJMP DESCAFE
	RET

CAFE:		;ACTIVA EL ADC PARA ECHAR CAFE
	RET
DESCAFE:	;ACTIVA EL ADC PARA ECHAR DESCAFE
	RET

TABLA_E2_EVENTOS:
	AJMP E2_EVENTO_0

E2_EVENTO_0:	;Estado vacio
	RET

E2_EVENTO_1:	;SE ECHA CAFE O DESCAFE?
	

E2_EVENTO_2:	;Se ha echado el cafe o descafe necesario

	
;**********************************************	ESTADO 3: MOLER CAFE
MOLER_CAFE:
	ACALL E3_GENERADOR_EVENTOS
	MOV A, EVENTO
	RL A
	MOV DPTR, #TABLA_E3_EVENTOS
	JMP @A+DPTR

E3_GENERADOR_EVENTOS:
	

TABLA_E3_EVENTOS:
	AJMP E3_EVENTO_0
	AJMP E3_EVENTO_1

E3_EVENTO_0:	;EVENTO VACIO
	RET

E3_EVENTO_1:
	RET

;**********************************************	ESTADO 4: ECHAR AGUA
ECHAR_AGUA:
	ACALL E4_GENERADOR_EVENTOS
	MOV A, EVENTO
	RL A
	MOV DPTR, #TABLA_E4_EVENTOS
	JMP @A+DPTR

TABLA_E4_EVENTOS:
	AJMP E4_EVENTO_0
	AJMP E4_EVENTO_1
	AJMP E4_EVENTO_2

E4_GENERADOR_EVENTOS:
	JB P_LLENO_AGUA, E4_PASAR_SIG_ESTADO	;P_LLENO_AGUA SE PONDRA A 1 MEDIANTE INTERRUPCION DEL TIMER
	JB ESTA_VACIO, E4_ECHAR_AGUA
	MOV EVENTO, #0X00
	RET

E4_ECHAR_AGUA:
	MOV EVENTO, #0X02
	CLR ESTA_VACIO
	RET

E4_PASAR_SIG_ESTADO:
	MOV EVENTO, #0X05
	RET

E4_EVENTO_0:
	RET

E4_EVENTO_1:
	MOV ESTADO, #0X05
	CLR P_LLENAR_AGUA
	;PRECONDICIONES PROXIMO ESTADO
	RET

E4_EVENTO_2:
	SETB P_LLENAR_AGUA
	RET
;**********************************************	ESTADO 5: CALENTAR AGUA
CALENTAR_AGUA:
;**********************************************	ESTADO 6: SERVIR CAFE
SERVIR_CAFE:
;**********************************************	ESTADO 7: ECHAR LECHE
ECHAR_LECHE:
;**********************************************	ESTADO 8: FIN
FIN:
;**********************************************	INTERRUPCIONES
SUB_TMR:
	RET

SUB_ADC:
	ACALL PESAR_CAFE
	RET

ADC_SETUP:
	SETB 0xA8.6 ;Activa la interrupcion del ADC
	ANL 0xC5, #11111000b
	ORL 0xC5, #00001000b

TIMER_SETUP:
	ORL TMOD #00000001b
	;?
	MOV TH0, #0XF8
	MOV TL0, #0X30
	SETB 0Xa8.1
	SETB TCOM.4
	MOV CONT0, #0
	MOV CONT1, #0
	MOV CONT2, #0
	
PWM_SETUP:
	MOV PWMP, #0X01
	MOV PWM0, #0XB3
;**********************************************FIN
END



